<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ Playwright Test Reports Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FFFFFF; /* White background */
            color: #4A4A4A; /* Dark gray for primary text */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align content to the top */
            padding: 20px; /* Padding around the entire content */
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0; /* Container itself doesn't need padding now that body has it */
        }

        .header {
            text-align: center;
            background: #FFFFFF; /* White background for header */
            padding: 25px 20px;
            border-radius: 12px; /* Soft rounded corners */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* Softer shadow for a light theme */
            color: #333333; /* Darker text for header */
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            text-shadow: none; /* Remove text shadow for cleaner look */
        }

        .header p {
            font-size: 1rem;
            color: #666666; /* Softer gray for tagline */
        }

        /* Stats Section */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #FFFFFF; /* White background for stat cards */
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); /* Lighter shadow */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            color: #4A4A4A; /* Dark text for stats */
            border: 1px solid #EEEEEE; /* Subtle border */
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* Slightly more prominent shadow on hover */
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333333; /* Neutral dark color for numbers (not directly status) */
        }

        .stat-label {
            color: #777777; /* Medium gray for labels */
            font-size: 0.9rem;
        }

        /* Controls/Filters */
        .controls {
            background: #FFFFFF; /* White background for controls */
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            border: 1px solid #EEEEEE; /* Subtle border */
        }

        .search-box,
        .filter-select {
            padding: 12px 18px;
            border: 1px solid #D0D0D0; /* Light gray border */
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: #F8F8F8; /* Very light gray input background */
            color: #4A4A4A; /* Dark text color */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23777777" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px;
            padding-right: 40px; /* Space for custom arrow */
        }

        .search-box::placeholder {
            color: #AAAAAA; /* Lighter placeholder text */
        }

        .search-box:focus,
        .filter-select:focus {
            border-color: #4CAF50; /* Green focus border */
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2); /* Soft green glow */
            background-color: #FFFFFF; /* White background on focus */
        }

        .filter-select option {
            background-color: #FFFFFF; /* White for options */
            color: #4A4A4A; /* Dark text for options */
        }

        .search-box {
            flex: 1;
            min-width: 220px;
        }

        /* Reports Grid and Cards */
        .reports-grid {
            display: grid;
            gap: 25px;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* Adjusted min-width for more cards per row */
        }

        .report-card {
            background: #FFFFFF; /* White background for report cards */
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            border-left: 5px solid #E0E0E0; /* Default neutral border */
            color: #4A4A4A; /* Dark text for report cards */
            font-size: 0.95rem;
            border: 1px solid #EEEEEE; /* Subtle overall border */
            
            /* Enhanced alignment for internal elements */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Pushes header to top, actions to bottom */
            min-height: 200px; /* Ensure a consistent minimum height for cards */
        }

        .report-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Status-based left borders */
        .report-card.latest {
            border-left-color: #6a4cd7; /* Keeping a distinct "latest" highlight */
            background: #FDFDFD; /* Slightly off-white for latest */
        }

        .report-card.success {
            border-left-color: #4CAF50; /* Green */
        }

        .report-card.failure {
            border-left-color: #E91E63; /* Red */
        }

        .report-card.broken {
            border-left-color: #E91E63; /* Same as failure for simplicity */
        }

        .status-badge.unknown {
            background: #B0B0B0; /* Neutral gray for unknown */
            color: white;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Aligns items to the top of the flex container */
            margin-bottom: 15px;
            font-size: 1.1rem;
            width: 100%; /* Ensure it takes full width */
        }

        .report-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333333; /* Darker text for titles */
            display: flex;
            flex-wrap: wrap; /* Allows items to wrap to the next line */
            align-items: center; /* Vertically centers items within their flex line */
            gap: 8px;
            flex-grow: 1;
            margin-right: 10px;
        }

        .folder-label,
        .run-number-badge {
            background: #E0E0E0; /* Light gray for badges */
            color: #4A4A4A; /* Dark text on light badge */
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-shadow: none; /* Remove text shadow */
            box-shadow: none; /* Remove badge shadow */
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            color: white;
            white-space: nowrap;
            margin-left: auto;
        }

        .status-badge.success {
            background: #4CAF50; /* Green */
        }

        .status-badge.failure {
            background: #E91E63; /* Red */
        }

        .status-badge.broken {
            background: #E91E63; /* Red */
        }

        .report-meta {
            color: #777777; /* Medium gray for meta info */
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: 500;
        }

        /* Environment and User Role badges (Neutral) */
        .badge-container {
            display: flex;
            gap: 8px;
            margin: 12px 0; /* Add margin to separate from other elements */
            flex-wrap: wrap;
            width: 100%; /* Ensure it takes full width */
        }

        .env-badge,
        .role-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #E0E0E0; /* Neutral light gray */
            color: #4A4A4A; /* Dark text */
            border: 1px solid #D0D0D0;
        }
        
        /* Specific env/role colors removed to adhere to two-color theme unless absolutely necessary */
        .env-badge.dev, .env-badge.stage, .env-badge.prod, .env-badge.unknown,
        .role-badge.b2c, .role-badge.b2b, .role-badge.unknown {
            background: #E0E0E0; /* All become neutral light gray */
            color: #4A4A4A;
            border: 1px solid #D0D0D0;
        }

        .test-summary {
            display: flex;
            gap: 15px;
            flex-wrap: wrap; /* Ensure it wraps on smaller screens */
            margin-top: auto; /* Push to bottom before actions */
            padding-top: 15px; /* Space from meta info */
            border-top: 1px solid #F0F0F0; /* Subtle separator */
            justify-content: space-around; /* Distribute items evenly */
        }

        .test-stat {
            text-align: center;
            flex: 1 1 auto; /* Allow items to grow/shrink and wrap */
            min-width: 70px; /* Minimum width for each stat */
        }

        .test-stat-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4A4A4A; /* Default to dark text */
        }

        .test-stat-label {
            font-size: 0.8rem;
            color: #777777; /* Medium gray */
        }

        /* Specific colors for test summary stats */
        .test-stat .test-stat-number[style*="color: rgb(76, 175, 80)"] { /* Matches #4CAF50 */
            color: #4CAF50 !important; /* Green */
        }
        .test-stat .test-stat-number[style*="color: rgb(244, 67, 54)"] { /* Matches #f44336 */
            color: #E91E63 !important; /* Red */
        }
        .test-stat .test-stat-number[style*="color: rgb(255, 152, 0)"] { /* Matches #ff9800 */
            color: #E91E63 !important; /* Assign orange/skipped/broken to Red for the two-color theme */
        }
        .test-stat .test-stat-number[style*="color: rgb(255, 152, 0)"] { /* Matches #ff9800 - for broken also */
            color: #E91E63 !important; /* Assign orange/skipped/broken to Red for the two-color theme */
        }


        .report-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%; /* Ensure it takes full width */
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: #4CAF50; /* Primary button is green */
            color: white;
        }

        .btn-primary:hover {
            background: #43A047; /* Slightly darker green on hover */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #E0E0E0; /* Secondary button is light gray */
            color: #4A4A4A; /* Dark text */
            border: 1px solid #D0D0D0;
        }
        .btn-secondary:hover {
            background: #D0D0D0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }


        .no-results {
            text-align: center;
            padding: 40px;
            color: #777777;
            font-size: 1.1rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666666; /* Darker gray for loading text */
        }

        /* --- CHART SECTION STYLES (Adjusted for White Background) --- */
        .chart-section {
            background: #FFFFFF; /* White background for chart section */
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); /* Softer shadow */
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 20px;
            border: 1px solid #EEEEEE; /* Subtle border */
        }

        .chart-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h2 {
            color: #333333; /* Dark text for chart titles */
        }

        .chart-filter-select {
            padding: 10px 15px;
            border: 1px solid #D0D0D0; /* Light border */
            border-radius: 6px;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s ease, background 0.2s ease;
            background-color: #F8F8F8; /* Very light input background */
            color: #4A4A4A; /* Dark text color */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23777777" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 18px;
            padding-right: 35px;
        }

        .chart-filter-select:focus {
            border-color: #4CAF50; /* Green focus border */
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2); /* Soft green glow */
            background-color: #FFFFFF; /* White background on focus */
        }

        .chart-filter-select option {
            background-color: #FFFFFF; /* White background for options */
            color: #4A4A4A; /* Dark text for options */
        }

        .chart-container {
            flex: 1;
            min-width: 350px;
            max-width: 48%;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            background: #FDFDFD; /* Slightly off-white for chart area */
            border: 1px solid #EEEEEE; /* Subtle border */
            border-radius: 10px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.02); /* Very subtle inner shadow */
        }
        
        /* Chart.js specific color adjustments for light background (handled in JS options) */
        .chart-container canvas {
            background-color: transparent;
        }

        /* --- TOP FAILURES BREAKDOWN SECTION (Adjusted for White Background) --- */
        .top-failures-breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: space-between;
        }

        .top-failures-card {
            flex: 1;
            min-width: 320px;
            max-width: 48%;
            background: #FFFFFF; /* White background */
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); /* Softer shadow */
            color: #4A4A4A; /* Dark text */
            border: 1px solid #EEEEEE; /* Subtle border */
        }

        .top-failures-card h2 {
            text-align: center;
            color: #333333; /* Dark text for titles */
            margin-bottom: 20px;
            font-size: 1.6rem;
        }

        .top-failures-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .top-failures-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #F0F0F0; /* Lighter separator */
        }

        .top-failures-item:last-child {
            border-bottom: none;
        }

        .top-failures-name {
            flex-grow: 1;
            font-size: 0.98em;
            color: #4A4A4A; /* Dark text for names */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 15px;
        }

        .top-failures-name strong {
            color: #E91E63; /* Red for failed item names */
        }

        .top-failures-count {
            background-color: #E91E63; /* Red badge */
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
            min-width: 35px;
            text-align: center;
        }

        .no-top-failures {
            text-align: center;
            padding: 20px;
            color: #777777; /* Medium gray for no results */
            font-style: italic;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .header h1 {
                font-size: 1.8rem;
            }
            .header p {
                font-size: 0.85rem;
            }
            .stats {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
            }
            .search-box {
                width: 100%;
                min-width: unset;
            }
            .report-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            .report-actions {
                flex-direction: column;
            }
            .chart-container,
            .top-failures-card {
                max-width: 100%;
                min-width: unset;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üé≠ Playwright Test Reports</h1>
            <p>Interactive Dashboard for Test Results</p>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-reports">-</div>
                <div class="stat-label">Total Reports</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="last-run">-</div>
                <div class="stat-label">Last Run</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-duration">-</div>
                <div class="stat-label">Avg Duration</div>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-header">
                <h2>Test Overview</h2>
                <select class="chart-filter-select" id="chart-timeframe-filter">
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="all">All Time</option>
                </select>
            </div>
            <div class="chart-container">
                <canvas id="stackedBarChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <div class="top-failures-breakdown">
            <div class="top-failures-card">
                <h2>Top 5 Failing Test Files</h2>
                <ul id="topFailingFilesList" class="top-failures-list">
                    <li class="no-top-failures">Loading...</li>
                </ul>
            </div>
            <div class="top-failures-card">
                <h2>Top 5 Error Reasons</h2>
                <ul id="topErrorReasonsList" class="top-failures-list">
                    <li class="no-top-failures">Loading...</li>
                </ul>
            </div>
        </div>
        <div class="controls">
            <input type="text" class="search-box" id="search" placeholder="üîç Search reports...">
            <select class="filter-select" id="status-filter">
                <option value="">All Status</option>
                <option value="success">‚úÖ Success</option>
                <option value="failure">‚ùå Failure</option>
                <option value="unknown">‚ùî Unknown</option>
                <option value="broken">‚ö†Ô∏è Broken</option>
            </select>
            <select class="filter-select" id="env-filter">
                <option value="">All Environments</option>
                <option value="dev">üîß Dev</option>
                <option value="stage">üß™ Stage</option>
                <option value="prod">üöÄ Prod</option>
            </select>
            <select class="filter-select" id="role-filter">
                <option value="">All Roles</option>
                <option value="b2c">üë§ B2C</option>
                <option value="b2b">üè¢ B2B</option>
            </select>
            <select class="filter-select" id="limit-filter">
                <option value="10">Last 10</option>
                <option value="25">Last 25</option>
                <option value="50">Last 50</option>
                <option value="">All Reports</option>
            </select>
        </div>

        <div class="loading" id="loading">Loading reports...</div>
        <div class="reports-grid" id="reports-container"></div>
        <div class="no-results" id="no-results" style="display: none;">
            No reports found matching your criteria.
        </div>
    </div>

    <script>
        let stackedBarChartInstance;
        let lineChartInstance;

        class ReportsManager {
            constructor() {
                this.reports = [];
                this.filteredReports = [];
                this.init();
            }

            async init() {
                await this.loadReports();
                this.setupEventListeners();
                this.renderStats();
                this.filterReports();
                this.setupChartFilter();
                this.updateCharts(); // Charts initially, also calls renderTopFailuresBreakdown
            }

            async loadReports() {
                try {
                    // Construct the absolute URL for reports.json
                    const reportsJsonUrl = new URL('reports.json', window.location.href).href;
                    const response = await fetch(reportsJsonUrl);
                    const data = await response.json();
                    this.reports = data.reports.sort((a, b) =>
                        new Date(b.dateFormatted) - new Date(a.dateFormatted)
                    );

                    // Process each report to extract and store the folderName
                    this.reports.forEach(report => {
                        report.folderName = this.getFolderNameFromReport(report);
                    });

                    if (this.reports.length > 0) {
                        this.reports[0].isLatest = true;
                    }

                    document.getElementById('loading').style.display = 'none';
                } catch (error) {
                    console.error('Error loading reports:', error);
                    document.getElementById('loading').innerHTML = 'Error loading reports or reports.json not found. Check console for details.';
                }
            }

            // Helper function to extract folder name
            getFolderNameFromReport(report) {
                let folderName = 'Unknown'; // Default value

                // Prioritize 'allTestsDetails' if available
                if (report.allTestsDetails && report.allTestsDetails.length > 0) {
                    const firstTestFile = report.allTestsDetails[0].testFile;
                    if (firstTestFile) {
                        const parts = firstTestFile.split('/');
                        // Check if the path starts with 'tests/' or similar
                        // Example: 'tests/smoke/my-test.spec.ts' -> 'smoke'
                        // Example: 'tests/my-test.spec.ts' -> 'my-test'
                        // Example: 'another_suite/my-test.spec.ts' -> 'another_suite'
                        if (parts.length >= 2 && parts[0].toLowerCase() === 'tests') {
                            folderName = parts[1]; // Get the folder name after 'tests/'
                        } else if (parts.length > 1) {
                            folderName = parts[0]; // Get the first part if no 'tests/' (e.g., 'another_suite')
                        } else {
                            // If it's just a file name (e.g., 'my-test.spec.ts'), use the file name without extension
                            folderName = firstTestFile.replace(/\.spec\.ts$/, '').replace(/\.js$/, '');
                        }
                    }
                } else if (report.path) {
                    // Fallback to extract from report.path if allTestsDetails is empty or unavailable
                    // The 'path' typically looks like 'reports/20250624_231641/'
                    const pathParts = report.path.split('/').filter(Boolean); // Filter Boolean removes empty strings
                    if (pathParts.length > 0) {
                        // The last part is usually the timestamp ID from the GH Actions artifact
                        folderName = pathParts[pathParts.length - 1];
                    }
                }
                return folderName;
            }


            setupEventListeners() {
                document.getElementById('search').addEventListener('input', () => this.filterReports());
                document.getElementById('status-filter').addEventListener('change', () => this.filterReports());
                document.getElementById('env-filter').addEventListener('change', () => this.filterReports());
                document.getElementById('role-filter').addEventListener('change', () => this.filterReports());
                document.getElementById('limit-filter').addEventListener('change', () => this.filterReports());
            }

            setupChartFilter() {
                document.getElementById('chart-timeframe-filter').addEventListener('change', () => {
                    this.updateCharts(); // This now updates all charts including top failures
                });
            }

            filterReports() {
                const search = document.getElementById('search').value.toLowerCase();
                const statusFilter = document.getElementById('status-filter').value;
                const envFilter = document.getElementById('env-filter').value;
                const roleFilter = document.getElementById('role-filter').value;
                const limitFilter = parseInt(document.getElementById('limit-filter').value);

                this.filteredReports = this.reports.filter(report => {
                    const matchesSearch = !search ||
                        report.id.toLowerCase().includes(search) ||
                        (report.runNumber && report.runNumber.toString().includes(search)) ||
                        (report.environment && report.environment.toLowerCase().includes(search)) ||
                        (report.userRole && report.userRole.toLowerCase().includes(search)) ||
                        (report.folderName && report.folderName.toLowerCase().includes(search)) || // Added folderName to search
                        (report.testSummary && JSON.stringify(report.testSummary).toLowerCase().includes(search));

                    const matchesStatus = !statusFilter || report.status === statusFilter;
                    const matchesEnv = !envFilter || report.environment === envFilter;
                    const matchesRole = !roleFilter || report.userRole === roleFilter;

                    return matchesSearch && matchesStatus && matchesEnv && matchesRole;
                });

                if (limitFilter) {
                    this.filteredReports = this.filteredReports.slice(0, limitFilter);
                }

                this.renderReports();
            }

            renderStats() {
                const totalReports = this.reports.length;
                const lastRun = this.reports.length > 0 ? this.formatDate(this.reports[0].dateFormatted) : 'Never';

                const avgDuration = this.calculateAverageDuration();

                document.getElementById('total-reports').textContent = totalReports;
                document.getElementById('last-run').textContent = lastRun;
                document.getElementById('avg-duration').textContent = avgDuration;
            }

            calculateAverageDuration() {
                const reportsWithDuration = this.reports.filter(report =>
                    report.testSummary &&
                    report.testSummary.time &&
                    report.testSummary.time.duration
                );

                if (reportsWithDuration.length === 0) return 'N/A';

                const totalDuration = reportsWithDuration.reduce((sum, report) =>
                    sum + report.testSummary.time.duration, 0);

                const avgDurationMs = totalDuration / reportsWithDuration.length;
                return this.formatDuration(avgDurationMs);
            }

            formatDuration(durationMs) {
                if (!durationMs || durationMs === 0) return 'N/A';

                const seconds = Math.floor(durationMs / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;

                if (minutes > 0) {
                    return `${minutes}m ${remainingSeconds}s`;
                } else {
                    return `${remainingSeconds}s`;
                }
            }

            formatTimestamp(timestamp) {
                try {
                    const date = new Date(timestamp);
                    if (isNaN(date.getTime())) {
                        return "Invalid Date";
                    }

                    return date.toLocaleString('en-US', {
                        year: '2-digit', // Changed to '2-digit'
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                } catch (e) {
                    console.error("Error formatting date:", e, dateString);
                    return "Invalid Date";
                }
            }

            formatDateTimeRange(report) {
                if (!report.dateFormatted) return 'üìÖ Date not available';

                const startDate = new Date(report.dateFormatted);

                // Changed to two-digit year
                const dateOnly = startDate.toLocaleDateString('en-US', {
                    year: '2-digit', // Changed to '2-digit'
                    month: '2-digit',
                    day: '2-digit'
                });

                const startTime = startDate.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });

                let endTime = '';
                let durationText = '';

                if (report.testSummary && report.testSummary.time && report.testSummary.time.duration) {
                    const durationMs = report.testSummary.time.duration;
                    const endDate = new Date(startDate.getTime() + durationMs);

                    endTime = endDate.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });

                    durationText = this.formatDuration(durationMs);

                    return `üìÖ ${dateOnly} ‚Ä¢ üïí ${startTime} ‚Üí ${endTime} ‚Ä¢ ‚è±Ô∏è ${durationText}`;
                } else {
                    return `üìÖ ${dateOnly} ‚Ä¢ üïí ${startTime}`;
                }
            }

            renderTimingInfo(testSummary) {
                return '';
            }

            renderReports() {
                const container = document.getElementById('reports-container');
                const noResults = document.getElementById('no-results');

                if (!container || !noResults) {
                    console.error("HTML elements 'reports-container' or 'no-results' not found.");
                    return;
                }

                if (this.filteredReports.length === 0) {
                    container.innerHTML = '';
                    noResults.style.display = 'block';
                    return;
                }

                noResults.style.display = 'none';

                container.innerHTML = this.filteredReports.map(report => {
                    const testSummaryHtml = this.renderTestSummary(report.testSummary);
                    const timingInfoHtml = this.renderTimingInfo(report.testSummary);

                    const dateObj = new Date(report.dateFormatted);
                    // Changed to two-digit year here as well for consistency in report cards
                    const formattedDateOnly = dateObj.toLocaleDateString('en-US', {
                        year: '2-digit', // Changed to '2-digit'
                        month: '2-digit',
                        day: '2-digit'
                    });

                    const envBadge = report.environment && report.environment !== 'unknown' ?
                        `<span class="env-badge ${report.environment}">${report.environment}</span>` :
                        `<span class="env-badge unknown">unknownEnv</span>`;

                    const roleBadge = report.userRole && report.userRole !== 'unknown' ?
                        `<span class="role-badge ${report.userRole}">${report.userRole}</span>` :
                        `<span class="role-badge unknown">unknownRole</span>`;

                    const runNumberBadge = report.runNumber ?
                        `<span class="run-number-badge">#${report.runNumber}</span>` :
                        '';

                    const folderLabel = `<span class="folder-label">üìÅ ${report.folderName || 'Unknown'}</span>`;


                    return `
                        <div class="report-card ${report.status} ${report.isLatest ? 'latest' : ''}">
                            <div class="report-header">
                                <div class="report-title">
                                    <span>${formattedDateOnly}</span>
                                    ${runNumberBadge}
                                    ${folderLabel}
                                    ${report.isLatest ? ' üåü' : ''}
                                </div>
                                <span class="status-badge ${report.status}">
                                    ${report.status === 'success' ? '‚úÖ PASSED' :
                                    report.status === 'failure' ? '‚ùå FAILED' :
                                    report.status === 'broken' ? '‚ö†Ô∏è BROKEN' : '‚ùî UNKNOWN'}
                                </span>
                            </div>
                            
                            <div class="badge-container">
                                ${envBadge}
                                ${roleBadge}
                            </div>
                            
                            <div class="report-meta">
                                ${this.formatDateTimeRange(report)}
                            </div>
                            
                            ${timingInfoHtml}
                            ${testSummaryHtml}
                            
                            <div class="report-actions">
                                <a href="${report.path}" class="btn btn-primary" target="_blank">üìä View Report</a>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderTestSummary(summary) {
                if (!summary || summary === 'N/A' || Object.keys(summary).length === 0) {
                    return '<div class="test-summary">Test details not available</div>';
                }

                try {
                    const data = typeof summary === 'string' ? JSON.parse(summary) : summary;

                    if (!data || !data.statistic) {
                        console.warn("Invalid summary data structure:", summary);
                        return '<div class="test-summary">Test details not available (bad structure)</div>';
                    }

                    return `
                        <div class="test-summary">
                            <div class="test-stat">
                                <div class="test-stat-number" style="color: #4CAF50">${data.statistic.passed || 0}</div>
                                <div class="test-stat-label">Passed</div>
                            </div>
                            <div class="test-stat">
                                <div class="test-stat-number" style="color: #E91E63">${data.statistic.failed || 0}</div>
                                <div class="test-stat-label">Failed</div>
                            </div>
                            <div class="test-stat">
                                <div class="test-stat-number" style="color: #E91E63">${data.statistic.skipped || 0}</div>
                                <div class="test-stat-label">Skipped</div>
                            </div>
                            <div class="test-stat">
                                <div class="test-stat-number" style="color: #E91E63">${data.statistic.broken || 0}</div>
                                <div class="test-stat-label">Broken</div>
                            </div>
                            <div class="test-stat">
                                <div class="test-stat-number">${data.statistic.total || 0}</div>
                                <div class="test-stat-label">Total</div>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error("Error parsing test summary:", e, summary);
                    return '<div class="test-summary">Error loading test details (parsing error)</div>';
                }
            }

            formatDate(dateString) {
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        return "Invalid Date";
                    }

                    return date.toLocaleString('en-US', {
                        year: '2-digit', // Changed to '2-digit'
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                } catch (e) {
                    console.error("Error formatting date:", e, dateString);
                    return "Invalid Date";
                }
            }

            copyLink(path) {
                const fullUrl = window.location.origin + window.location.pathname.replace('/index.html', '') + '/' + path;
                document.execCommand('copy'); // Use document.execCommand for clipboard operations within iframe
                const messageBox = document.createElement('div');
                messageBox.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background-color: #4A4A4A; /* Dark gray for message box */
                    color: white;
                    padding: 15px 30px;
                    border-radius: 8px;
                    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
                    z-index: 1000;
                    font-family: sans-serif;
                    font-size: 1rem;
                `;
                messageBox.textContent = 'Link copied to clipboard!';
                document.body.appendChild(messageBox);
                setTimeout(() => {
                    document.body.removeChild(messageBox);
                }, 2000); // Remove after 2 seconds
            }

            // Centralized chart and top failures update function
            updateCharts() {
                const timeframeFilter = document.getElementById('chart-timeframe-filter').value;
                const filteredReportsForCharts = this.getReportsByTimeframe(timeframeFilter);

                this.renderStackedBarChart(filteredReportsForCharts);
                this.renderLineChart(filteredReportsForCharts);
                this.renderTopFailuresBreakdown(filteredReportsForCharts); // This call is essential now
            }

            // Filter reports by timeframe (already exists)
            getReportsByTimeframe(timeframe) {
                const now = new Date();
                let filterDate = new Date();

                if (timeframe === '7') {
                    filterDate.setDate(now.getDate() - 7);
                } else if (timeframe === '30') {
                    filterDate.setDate(now.getDate() - 30);
                } else {
                    return this.reports; // 'all' or default
                }

                return this.reports.filter(report => {
                    const reportDate = new Date(report.dateFormatted);
                    return reportDate >= filterDate;
                });
            }

            renderStackedBarChart(dataToChart) {
                const ctxBar = document.getElementById('stackedBarChart').getContext('2d');

                if (stackedBarChartInstance) {
                    stackedBarChartInstance.destroy();
                }

                const aggregatedData = {};
                dataToChart.forEach(report => {
                    // Changed to two-digit year
                    const date = new Date(report.dateFormatted).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: '2-digit' // Changed to '2-digit'
                    });
                    if (!aggregatedData[date]) {
                        aggregatedData[date] = {
                            passed: 0,
                            failed: 0
                        };
                    }
                    if (report.testSummary?.statistic?.passed) {
                        aggregatedData[date].passed += report.testSummary.statistic.passed;
                    }
                    if (report.testSummary?.statistic?.failed) {
                        aggregatedData[date].failed += report.testSummary.statistic.failed;
                    }
                });

                const labels = Object.keys(aggregatedData).sort((a, b) => {
                    // Improved parseDateForSort to handle two-digit years more gracefully
                    const parseDateForSort = (dateStr) => {
                        const parts = dateStr.match(/(\w{3})\s(\d{1,2}),\s(\d{2})/); // Match "Mon Day, YY"
                        if (parts) {
                            const [_, monthStr, dayStr, yearStr] = parts;
                            const monthMap = {
                                'Jan': 0,
                                'Feb': 1,
                                'Mar': 2,
                                'Apr': 3,
                                'May': 4,
                                'Jun': 5,
                                'Jul': 6,
                                'Aug': 7,
                                'Sep': 8,
                                'Oct': 9,
                                'Nov': 10,
                                'Dec': 11
                            };
                            const month = monthMap[monthStr];
                            const day = parseInt(dayStr);
                            const year = 2000 + parseInt(yearStr); // Assume 20xx for two-digit years
                            return new Date(year, month, day);
                        }
                        return new Date(dateStr); // Fallback for other formats
                    };
                    return parseDateForSort(a) - parseDateForSort(b);
                });

                const passedPercentages = [];
                const failedPercentages = [];

                labels.forEach(date => {
                    const total = aggregatedData[date].passed + aggregatedData[date].failed;
                    if (total > 0) {
                        passedPercentages.push((aggregatedData[date].passed / total) * 100);
                        failedPercentages.push((aggregatedData[date].failed / total) * 100);
                    } else {
                        passedPercentages.push(0);
                        failedPercentages.push(0);
                    }
                });

                stackedBarChartInstance = new Chart(ctxBar, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Passed %',
                            data: passedPercentages,
                            backgroundColor: '#4CAF50', /* Green */
                            borderColor: '#43A047',
                            borderWidth: 1
                        }, {
                            label: 'Failed %',
                            data: failedPercentages,
                            backgroundColor: '#E91E63', /* Red */
                            borderColor: '#C2185B',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Date',
                                    color: '#777777' /* Medium gray for axis titles on light background */
                                },
                                ticks: {
                                    color: '#777777' /* Medium gray for ticks on light background */
                                },
                                grid: {
                                    color: '#EEEEEE' /* Light grid lines on light background */
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Percentage (%)',
                                    color: '#777777'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    },
                                    color: '#777777'
                                },
                                grid: {
                                    color: '#EEEEEE'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Passed vs Failed Percentage by Date',
                                color: '#333333' /* Dark title color for light background */
                            },
                            legend: {
                                display: true,
                                labels: {
                                    color: '#4A4A4A' /* Dark text for legend labels on light background */
                                }
                            },
                            tooltip: {
                                backgroundColor: '#4A4A4A', /* Dark gray tooltip background */
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: '#777777',
                                borderWidth: 1
                            }
                        }
                    }
                });
            }

            renderLineChart(dataToChart) {
                const ctxLine = document.getElementById('lineChart').getContext('2d');

                if (lineChartInstance) {
                    lineChartInstance.destroy();
                }

                const sortedData = dataToChart.sort((a, b) => new Date(a.dateFormatted) - new Date(b.dateFormatted));

                const aggregatedData = {};
                sortedData.forEach(report => {
                    // Changed to two-digit year
                    const date = new Date(report.dateFormatted).toLocaleDateString('en-US', {
                        month: '2-digit',
                        day: '2-digit',
                        year: '2-digit' // Changed to '2-digit'
                    });
                    if (!aggregatedData[date]) {
                        aggregatedData[date] = {
                            passed: 0,
                            failed: 0
                        };
                    }
                    if (report.testSummary?.statistic?.passed) {
                        aggregatedData[date].passed += report.testSummary.statistic.passed;
                    }
                    if (report.testSummary?.statistic?.failed) {
                        aggregatedData[date].failed += report.testSummary.statistic.failed;
                    }
                });

                const labels = Object.keys(aggregatedData);
                const passedData = labels.map(date => aggregatedData[date].passed);
                const failedData = labels.map(date => aggregatedData[date].failed);

                lineChartInstance = new Chart(ctxLine, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Passed',
                            data: passedData,
                            borderColor: '#4CAF50', /* Green */
                            backgroundColor: 'rgba(76, 175, 80, 0.2)', /* Translucent green */
                            tension: 0.3,
                            fill: true
                        }, {
                            label: 'Failed',
                            data: failedData,
                            borderColor: '#E91E63', /* Red */
                            backgroundColor: 'rgba(233, 30, 99, 0.2)', /* Translucent red */
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Test Count',
                                    color: '#777777'
                                },
                                ticks: {
                                    color: '#777777'
                                },
                                grid: {
                                    color: '#EEEEEE'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date',
                                    color: '#777777'
                                },
                                ticks: {
                                    color: '#777777'
                                },
                                grid: {
                                    color: '#EEEEEE'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Passed/Failed Trend Over Time',
                                color: '#333333'
                            },
                            legend: {
                                labels: {
                                    color: '#4A4A4A' /* Dark text for legend labels */
                                }
                            },
                            tooltip: {
                                backgroundColor: '#4A4A4A',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: '#777777',
                                borderWidth: 1
                            }
                        }
                    }
                });
            }

            // NEW: Function to render the top failures breakdown
            renderTopFailuresBreakdown(dataForAnalysis) {
                const topFailingFilesList = document.getElementById('topFailingFilesList');
                const topErrorReasonsList = document.getElementById('topErrorReasonsList');

                topFailingFilesList.innerHTML = ''; // Clear previous content
                topErrorReasonsList.innerHTML = ''; // Clear previous content

                const fileFailures = {};
                const errorReasons = {};

                // Iterate through reports within the filtered timeframe
                dataForAnalysis.forEach(report => {
                    // Access failedTestsDetails directly from the report object
                    if (report.failedTestsDetails && report.failedTestsDetails.length > 0) {
                        report.failedTestsDetails.forEach(testError => {
                            // Aggregate by test file
                            const fileName = testError.testFile || 'Unknown File';
                            fileFailures[fileName] = (fileFailures[fileName] || 0) + 1;

                            // Aggregate by error reason (briefly)
                            const rawErrorMessage = testError.errorMessage || 'No message';
                            let briefErrorMessage = rawErrorMessage.split('\n')[0]; // Take first line
                            if (briefErrorMessage.length > 80) { // Limit length for display
                                briefErrorMessage = briefErrorMessage.substring(0, 80) + '...';
                            }
                            briefErrorMessage = briefErrorMessage.trim();

                            errorReasons[briefErrorMessage] = (errorReasons[briefErrorMessage] || 0) + 1;
                        });
                    }
                });

                // Sort and render Top 10 Failing Test Files
                const sortedFileFailures = Object.entries(fileFailures)
                    .sort(([, countA], [, countB]) => countB - countA)
                    .slice(0, 5); // Top 5

                if (sortedFileFailures.length > 0) {
                    sortedFileFailures.forEach(([fileName, count]) => {
                        const item = document.createElement('li');
                        item.className = 'top-failures-item';
                        item.innerHTML = `
                                <span class="top-failures-name">${fileName}</span>
                                <span class="top-failures-count">${count}</span>
                            `;
                        topFailingFilesList.appendChild(item);
                    });
                } else {
                    topFailingFilesList.innerHTML = '<li class="no-top-failures">No failing files in this timeframe.</li>';
                }

                // Sort and render Top 10 Error Reasons
                const sortedErrorReasons = Object.entries(errorReasons)
                    .sort(([, countA], [, countB]) => countB - countA)
                    .slice(0, 5); // Top 5

                if (sortedErrorReasons.length > 0) {
                    sortedErrorReasons.forEach(([reason, count]) => {
                        const item = document.createElement('li');
                        item.className = 'top-failures-item';
                        item.innerHTML = `
                                <span class="top-failures-name">${reason}</span>
                                <span class="top-failures-count">${count}</span>
                            `;
                        topErrorReasonsList.appendChild(item);
                    });
                } else {
                    topErrorReasonsList.innerHTML = '<li class="no-top-failures">No common error reasons in this timeframe.</li>';
                }
            }
        }

        const reportManager = new ReportsManager();
    </script>
</body>

</html>